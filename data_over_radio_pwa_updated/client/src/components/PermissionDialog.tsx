import { useState, useEffect } from 'react';\nimport { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogHeader, AlertDialogTitle } from '@/components/ui/alert-dialog';\nimport { Button } from '@/components/ui/button';\nimport { Card } from '@/components/ui/card';\nimport { Alert, AlertDescription } from '@/components/ui/alert';\nimport { Headphones, Smartphone, AlertTriangle, CheckCircle2, Clock } from 'lucide-react';\nimport HardwareDetector, { HardwareStatus } from '@/lib/hardwareDetector';\n\ninterface PermissionDialogProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onPermissionGranted: () => void;\n  onPermissionDenied: () => void;\n}\n\nexport function PermissionDialog({\n  isOpen,\n  onClose,\n  onPermissionGranted,\n  onPermissionDenied,\n}: PermissionDialogProps) {\n  const [step, setStep] = useState<'hardware' | 'permission' | 'success'>('hardware');\n  const [hardwareStatus, setHardwareStatus] = useState<HardwareStatus | null>(null);\n  const [isChecking, setIsChecking] = useState(true);\n  const [requiresHeadphones, setRequiresHeadphones] = useState(false);\n  const [headphoneMessage, setHeadphoneMessage] = useState('');\n  const [recommendations, setRecommendations] = useState<string[]>([]);\n\n  useEffect(() => {\n    if (isOpen) {\n      checkHardware();\n    }\n  }, [isOpen]);\n\n  const checkHardware = async () => {\n    setIsChecking(true);\n    try {\n      const status = await HardwareDetector.getHardwareStatus();\n      const required = await HardwareDetector.areHeadphonesRequired();\n      const message = await HardwareDetector.getHardwareRequirementMessage();\n      const recs = await HardwareDetector.getDeviceRecommendations();\n\n      setHardwareStatus(status);\n      setRequiresHeadphones(required);\n      setHeadphoneMessage(message);\n      setRecommendations(recs);\n\n      // If headphones are required but not connected, show hardware step\n      if (required && !status.hasHeadphones) {\n        setStep('hardware');\n      } else {\n        setStep('permission');\n      }\n    } catch (error) {\n      console.error('Error checking hardware:', error);\n    } finally {\n      setIsChecking(false);\n    }\n  };\n\n  const handleRequestPermission = async () => {\n    try {\n      // Request microphone permission\n      const stream = await navigator.mediaDevices.getUserMedia({\n        audio: {\n          echoCancellation: false,\n          noiseSuppression: false,\n          autoGainControl: false,\n        },\n      });\n\n      // Stop the stream (we just wanted to request permission)\n      stream.getTracks().forEach((track) => track.stop());\n\n      setStep('success');\n      setTimeout(() => {\n        onPermissionGranted();\n        onClose();\n      }, 2000);\n    } catch (error) {\n      console.error('Permission denied:', error);\n      onPermissionDenied();\n      onClose();\n    }\n  };\n\n  const handleRetryHeadphones = async () => {\n    await checkHardware();\n  };\n\n  return (\n    <AlertDialog open={isOpen} onOpenChange={onClose}>\n      <AlertDialogContent className=\"max-w-md\">\n        {step === 'hardware' && (\n          <>\n            <AlertDialogHeader>\n              <div className=\"flex items-center gap-2\">\n                <AlertTriangle className=\"text-amber-500\" size={24} />\n                <AlertDialogTitle>ØªØ­Ø°ÙŠØ±: Ø§Ù„Ø³Ù…Ø§Ø¹Ø§Øª Ù…Ø·Ù„ÙˆØ¨Ø©</AlertDialogTitle>\n              </div>\n            </AlertDialogHeader>\n            <AlertDialogDescription className=\"space-y-4\">\n              <div className=\"bg-amber-50 border border-amber-200 rounded-lg p-4\">\n                <p className=\"text-amber-900 font-medium mb-2\">âš ï¸ {headphoneMessage}</p>\n              </div>\n\n              {recommendations.length > 0 && (\n                <div className=\"space-y-2\">\n                  <p className=\"font-semibold text-sm text-gray-700\">Ø§Ù„ØªÙˆØµÙŠØ§Øª:</p>\n                  <ul className=\"space-y-1\">\n                    {recommendations.map((rec, idx) => (\n                      <li key={idx} className=\"text-sm text-gray-600 flex gap-2\">\n                        <span className=\"text-amber-500\">â€¢</span>\n                        <span>{rec}</span>\n                      </li>\n                    ))}\n                  </ul>\n                </div>\n              )}\n\n              <div className=\"bg-blue-50 border border-blue-200 rounded-lg p-4\">\n                <p className=\"text-blue-900 text-sm\">\n                  ğŸ’¡ Ø¨Ø¹Ø¯ ØªÙˆØµÙŠÙ„ Ø§Ù„Ø³Ù…Ø§Ø¹Ø§ØªØŒ Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ \"ØªØ­Ø¯ÙŠØ«\" Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„.\n                </p>\n              </div>\n            </AlertDialogDescription>\n            <div className=\"flex gap-2 justify-end\">\n              <AlertDialogCancel>Ø¥ØºÙ„Ø§Ù‚</AlertDialogCancel>\n              <Button onClick={handleRetryHeadphones} className=\"bg-blue-600 hover:bg-blue-700\">\n                ğŸ”„ ØªØ­Ø¯ÙŠØ«\n              </Button>\n            </div>\n          </>\n        )}\n\n        {step === 'permission' && (\n          <>\n            <AlertDialogHeader>\n              <div className=\"flex items-center gap-2\">\n                <Smartphone className=\"text-cyan-500\" size={24} />\n                <AlertDialogTitle>Ø·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†</AlertDialogTitle>\n              </div>\n            </AlertDialogHeader>\n            <AlertDialogDescription className=\"space-y-4\">\n              <div className=\"bg-cyan-50 border border-cyan-200 rounded-lg p-4\">\n                <p className=\"text-cyan-900\">\n                  ÙŠØ­ØªØ§Ø¬ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¥Ù„Ù‰ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø±Ø§Ø¯ÙŠÙˆ.\n                </p>\n              </div>\n\n              {hardwareStatus && (\n                <Card className=\"p-4 bg-gray-50\">\n                  <div className=\"space-y-2 text-sm\">\n                    <div className=\"flex items-center justify-between\">\n                      <span className=\"text-gray-600\">Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø²:</span>\n                      <span className=\"font-medium\">\n                        {hardwareStatus.deviceType === 'android'\n                          ? 'ğŸ“± Android'\n                          : hardwareStatus.deviceType === 'ios'\n                            ? 'ğŸ iOS'\n                            : hardwareStatus.deviceType === 'desktop'\n                              ? 'ğŸ’» Desktop'\n                              : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}\n                      </span>\n                    </div>\n                    <div className=\"flex items-center justify-between\">\n                      <span className=\"text-gray-600\">Ø§Ù„Ø³Ù…Ø§Ø¹Ø§Øª:</span>\n                      <span className=\"font-medium\">\n                        {hardwareStatus.hasHeadphones ? 'âœ… Ù…ØªØµÙ„Ø©' : 'âŒ ØºÙŠØ± Ù…ØªØµÙ„Ø©'}\n                      </span>\n                    </div>\n                    <div className=\"flex items-center justify-between\">\n                      <span className=\"text-gray-600\">Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†:</span>\n                      <span className=\"font-medium\">\n                        {hardwareStatus.hasAudioInput ? 'âœ… Ù…ØªØ§Ø­' : 'âŒ ØºÙŠØ± Ù…ØªØ§Ø­'}\n                      </span>\n                    </div>\n                  </div>\n                </Card>\n              )}\n\n              <Alert className=\"bg-blue-50 border-blue-200\">\n                <AlertDescription className=\"text-blue-900\">\n                  â„¹ï¸ Ø³ÙŠØªÙ… Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù† Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ´ØºÙŠÙ„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ \"Ø§Ù„Ø³Ù…Ø§Ø­\" Ø¹Ù†Ø¯ Ø¸Ù‡ÙˆØ± Ø§Ù„Ø·Ù„Ø¨.\n                </AlertDescription>\n              </Alert>\n            </AlertDialogDescription>\n            <div className=\"flex gap-2 justify-end\">\n              <AlertDialogCancel>Ø¥Ù„ØºØ§Ø¡</AlertDialogCancel>\n              <AlertDialogAction\n                onClick={handleRequestPermission}\n                className=\"bg-cyan-600 hover:bg-cyan-700\"\n              >\n                Ø·Ù„Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª\n              </AlertDialogAction>\n            </div>\n          </>\n        )}\n\n        {step === 'success' && (\n          <>\n            <AlertDialogHeader>\n              <div className=\"flex items-center gap-2\">\n                <CheckCircle2 className=\"text-emerald-500\" size={24} />\n                <AlertDialogTitle>ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!</AlertDialogTitle>\n              </div>\n            </AlertDialogHeader>\n            <AlertDialogDescription className=\"space-y-4 text-center\">\n              <div className=\"bg-emerald-50 border border-emerald-200 rounded-lg p-6\">\n                <p className=\"text-emerald-900 font-medium text-lg\">âœ… ØªÙ… Ù…Ù†Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</p>\n                <p className=\"text-emerald-800 text-sm mt-2\">Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¢Ù†!</p>\n              </div>\n              <p className=\"text-sm text-gray-600 flex items-center justify-center gap-1\">\n                <Clock size={16} />\n                Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡...\n              </p>\n            </AlertDialogDescription>\n          </>\n        )}\n      </AlertDialogContent>\n    </AlertDialog>\n  );\n}\n
